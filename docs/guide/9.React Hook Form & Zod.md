# 9. React Hook Form & Zod によるフォーム開発

本章では、**React Hook Form** と **Zod** を導入して、より堅牢で開発効率の高いフォーム実装を行います。

この章では下記ブランチを利用します。  
`ch9/form-validation`

## 9.1 フォームライブラリの必要性

5章で実装した標準的なフォーム実装（`FormData` や `useState`）には、フォームが複雑になるにつれて以下のような課題が生じやすくなります。

1.  **バリデーションロジックの肥大化**: 必須チェック、形式チェック、相関チェックなどを自前で書くとコードが複雑になる。
2.  **型安全性の欠如**: `FormData` から取得した値はすべて `string` や `File` になるため、数値への変換や型キャストが必要になる。
3.  **パフォーマンス**: `useState` で入力を管理すると、一文字入力するたびに再レンダリングが発生する（React Hook Form はこれを回避できる）。

これらの課題を解決するために、以下のライブラリを組み合わせる構成が、現在のReact開発のデファクトスタンダードとなっています。

*   **React Hook Form**: 非制御コンポーネントベースの軽量なフォームライブラリ。再レンダリングを最小限に抑える。
*   **Zod**: TypeScript First のスキーマ宣言・バリデーションライブラリ。

## 9.2 フォームライブラリ開発

それでは、実際にライブラリを導入してフォームを開発していきます。

### 9.2.1 ライブラリのインストール

まずは必要なライブラリをインストールします。
フォーム管理本体の `react-hook-form`、バリデーションスキーマ定義用の `zod`、そして両者を連携させるための `@hookform/resolvers` を追加します。

```bash
pnpm add react-hook-form zod @hookform/resolvers
```

### 9.2.2 Zod によるスキーマ定義

バリデーションルールを「スキーマ」として定義します。
`app/features/items/schema.ts` を作成し、以下のように記述します。

**app/features/items/schema.ts**

```typescript
import { z } from "zod";

export const itemSchema = z.object({
  name: z.string().min(1, "商品名は必須です"),
  price: z
    .number()
    .min(1, "価格は1円以上で入力してください")
    .int("価格は整数で入力してください"),
  description: z.string().min(1, "商品説明は必須です"),
  status: z.enum(["on_sale", "sold_out"]),
});

// スキーマから型を自動生成
export type ItemInput = z.infer<typeof itemSchema>;
```

*   `z.number()`: 数値型であることを検証します。
*   `z.infer`: 定義したスキーマから TypeScript の型を自動生成します。これにより、バリデーションルールと型定義の二重管理を防げます。
*   `status`: `.default()` を削除し、必須項目として定義します（初期値は `useForm` 側で制御します）。

## 9.2.3 React Hook Form の導入

次に、作成したスキーマを使ってフォームコンポーネントを実装します。
`app/features/items/pages/ItemCreatePage.tsx` を修正します。

#### フックのセットアップ

`useForm` フックを使用し、`resolver` オプションに Zod スキーマを渡すことで、バリデーションロジックを自動的に適用できます。

```tsx
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { itemSchema, type ItemInput } from "../schema";

// ...

export function ItemCreatePage() {
  const { mutateAsync, isSubmitting: isMutationSubmitting, errorMessage } = useItemCreate();

  const {
    register,
    handleSubmit,
    formState: { errors, isSubmitting: isFormSubmitting },
  } = useForm<ItemInput>({
    // ZodスキーマをReact Hook Formに接続
    resolver: zodResolver(itemSchema),
    defaultValues: {
      name: "",
      price: 0,
      description: "",
      status: "on_sale",
    },
  });

  const isSubmitting = isMutationSubmitting || isFormSubmitting;

  // バリデーションが成功したときだけ呼ばれる関数
  const onSubmit = async (data: ItemInput) => {
    // data は既にバリデーション済みかつ適切な型（数値など）に変換されている
    await mutateAsync(data);
  };

  // ...
}
```

### 9.2.4 UIコンポーネントの実装

MUI の `TextField` などのコンポーネントと React Hook Form を連携させるには、`register` 関数を使用します。
数値項目（価格）については、`valueAsNumber: true` オプションを指定して、入力値を数値として扱います。

```tsx
// ...
  return (
    // ...
      {/* handleSubmitでラップすることで、送信前にバリデーションが実行される */}
      <Box component="form" onSubmit={handleSubmit(onSubmit)} noValidate sx={{ display: "flex", flexDirection: "column", gap: 3 }}>
        <TextField
          label="商品名"
          required
          fullWidth
          disabled={isSubmitting}
          // エラーオブジェクトが存在するかどうかを boolean に変換
          error={!!errors.name}
          helperText={errors.name?.message}
          // スプレッド構文で展開（onChange, onBlur, name, ref などが含まれる）
          {...register("name")}
        />
        <TextField
          label="価格"
          type="number"
          required
          fullWidth
          disabled={isSubmitting}
          error={!!errors.price}
          helperText={errors.price?.message}
          {...register("price", { valueAsNumber: true })}
        />
        <TextField
          label="商品説明"
          multiline
          rows={4}
          fullWidth
          disabled={isSubmitting}
          error={!!errors.description}
          helperText={errors.description?.message}
          {...register("description")}
        />
        
        {/* ... other code ... */}
      </Box>
    // ...
  );
}
```

*   `{...register("name")}`: これだけで、入力値の取得、変更検知、バリデーション実行などがすべて紐付けられます（裏側で `onChange` や `value` が自動設定されます）。
*   `{...register("price", { valueAsNumber: true })}`: 入力値を数値として取得します。これにより `z.number()` のバリデーションが正しく機能します。
*   `error={!!errors.name}`: `!!` は値を `true/false` に変換する記法です。エラーがある場合に赤枠を表示します。
*   `helperText={errors.name?.message}`: Zod で定義したエラーメッセージを表示します。

## 9.3 まとめ

React Hook Form と Zod を導入することで、以下のメリットが得られました。

1.  **宣言的なバリデーション**: `schema.ts` を見るだけで、どのような入力ルールがあるかが一目瞭然になりました。
2.  **型安全性**: バリデーションを通過したデータ（`onSubmit` の引数）は、確実にスキーマ通りの型であることが保証されます。
3.  **コードの簡素化**: バリデーションロジックやエラーメッセージの管理をライブラリに任せることで、コンポーネントのコードがシンプルになりました。

